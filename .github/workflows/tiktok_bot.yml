name: TikTok Bot (VPN WireGuard)

on:
  schedule:
    - cron: '0 8 * * *' # Lance tous les jours √† 8h00 UTC
  workflow_dispatch: # Permet de lancer manuellement pour tester

jobs:
  run-with-vpn:
    runs-on: ubuntu-latest
    # Cette option est CRUCIALE : elle donne les droits "Admin R√©seau" pour lancer le VPN
    container:
      image: python:3.11-bookworm
      options: --cap-add=NET_ADMIN --device /dev/net/tun 

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. INSTALLATION & CONNEXION VPN
      - name: Setup WireGuard
        run: |
          apt-get update && apt-get install -y wireguard openresolv iproute2 curl
          echo "${{ secrets.WIREGUARD_CONF }}" > /etc/wireguard/wg0.conf
          chmod 600 /etc/wireguard/wg0.conf
          wg-quick up wg0
          
          # Petite pause pour laisser la connexion s'√©tablir
          sleep 2
          
          # PREUVE QUE √áA MARCHE : On affiche l'IP publique utilis√©e
          echo "üåç MON IP ACTUELLE EST :"
          curl -s ifconfig.me
          # Si tu vois 213.239... dans les logs, c'est gagn√© !

      # 2. INSTALLATION PYTHON
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 3. LANCEMENT DU BOT (Sous protection VPN)
      - name: Run Bot
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python main.py


