name: TikTok Bot (VPN Fix)

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  run-vpn:
    runs-on: ubuntu-latest
    # On donne les pleins pouvoirs r√©seau au conteneur
    container:
      image: python:3.11-bookworm
      options: --cap-add=NET_ADMIN --device /dev/net/tun --sysctl net.ipv6.conf.all.disable_ipv6=0

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Tools
        run: |
          apt-get update
          apt-get install -y wireguard iproute2 curl openresolv

      # C'EST ICI LE CORRECTIF "MANUEL"
      - name: Start Manual VPN
        run: |
          # 1. Cr√©ation du fichier de config
          echo "${{ secrets.WIREGUARD_CONF }}" > wg0.conf
          chmod 600 wg0.conf
          
          # 2. Cr√©ation de l'interface r√©seau virtuelle
          ip link add dev wg0 type wireguard
          
          # 3. Assignation de ton IP priv√©e (Celle qui est dans ton secret)
          ip address add 10.0.192.56/32 dev wg0
          
          # 4. Chargement de la config
          wg setconf wg0 wg0.conf
          
          # 5. Activation de l'interface
          ip link set up dev wg0
          
          # 6. ROUTAGE (Le moment d√©licat)
          # On ajoute une route pour que tout le trafic passe par le VPN
          ip route add 0.0.0.0/0 dev wg0
          
          # Petite pause pour laisser le tunnel se stabiliser
          sleep 3
          
          # 7. PREUVE DE FONCTIONNEMENT
          echo "üåç Test de l'IP publique..."
          curl --max-time 5 https://ifconfig.me
          # Si √ßa affiche l'IP de ton serveur (213...), c'est GAGN√â.

      - name: Install Python Deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Bot
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python main.py


