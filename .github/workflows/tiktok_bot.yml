name: TikTok Bot (VPN Routing Fix)

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  run-vpn:
    runs-on: ubuntu-latest
    # Droits admin r√©seau obligatoires
    container:
      image: python:3.11-bookworm
      options: --cap-add=NET_ADMIN --device /dev/net/tun --sysctl net.ipv6.conf.all.disable_ipv6=0

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Tools
        run: |
          apt-get update
          apt-get install -y wireguard iproute2 curl

      - name: Start Manual VPN
        run: |
          # 1. Pr√©paration de la config (Nettoyage pour 'wg setconf')
          echo "${{ secrets.WIREGUARD_CONF }}" > full.conf
          grep -v "Address" full.conf | grep -v "DNS" | grep -v "MTU" > wg0.conf
          chmod 600 wg0.conf
          
          # 2. Montage de l'interface
          ip link add dev wg0 type wireguard
          ip address add 10.0.192.56/32 dev wg0
          wg setconf wg0 wg0.conf
          ip link set up dev wg0
          
          # --- C'EST ICI QUE LA MAGIE DU ROUTAGE OP√àRE ---
          
          # A. On r√©cup√®re la passerelle internet actuelle du serveur GitHub
          DEFAULT_GW=$(ip route show default | awk '{print $3}')
          echo "Passerelle d√©tect√©e : $DEFAULT_GW"
          
          # B. On "√©pingle" ton serveur VPN (213.239.219.28) pour qu'il passe par la vraie internet
          # (Sinon le tunnel essaie de passer dans le tunnel et √ßa coupe tout)
          ip route add 213.239.219.28 via $DEFAULT_GW
          
          # C. On redirige tout le reste d'internet vers le VPN via l'astuce des "Deux moiti√©s"
          # Cela √©vite l'erreur "File exists"
          ip route add 0.0.0.0/1 dev wg0
          ip route add 128.0.0.0/1 dev wg0
          
          # D. Petite pause caf√© pour la connexion
          sleep 3
          
          # 4. PREUVE FINALE
          echo "üåç Test IP publique..."
          curl --max-time 5 https://ifconfig.me
          # Si √ßa affiche 213.239..., tu as gagn√©.

      - name: Install Python Deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Bot
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python main.py
