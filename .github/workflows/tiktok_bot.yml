name: TikTok Bot (VPN Final)

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  run-vpn:
    runs-on: ubuntu-latest
    # Droits d'administration r√©seau obligatoires
    container:
      image: python:3.11-bookworm
      options: --cap-add=NET_ADMIN --device /dev/net/tun --sysctl net.ipv6.conf.all.disable_ipv6=0

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Tools
        run: |
          apt-get update
          apt-get install -y wireguard iproute2 curl

      - name: Start VPN (Clean Config)
        run: |
          # 1. On √©crit ta config compl√®te dans un fichier temporaire
          echo "${{ secrets.WIREGUARD_CONF }}" > full.conf
          
          # 2. NETTOYAGE : On enl√®ve Address et DNS car 'wg' ne les aime pas
          grep -v "Address" full.conf | grep -v "DNS" | grep -v "MTU" > wg0.conf
          chmod 600 wg0.conf
          
          # 3. Cr√©ation de l'interface
          ip link add dev wg0 type wireguard
          
          # 4. On ajoute l'adresse IP manuellement (Celle de ton erreur)
          ip address add 10.0.192.56/32 dev wg0
          
          # 5. On charge la config nettoy√©e
          wg setconf wg0 wg0.conf
          
          # 6. On allume
          ip link set up dev wg0
          
          # 7. ROUTAGE : Tout le trafic passe par le tunnel
          ip route add 0.0.0.0/0 dev wg0
          
          sleep 3
          
          # 8. PREUVE
          echo "üåç IP AVANT : (Masqu√©e)"
          echo "üåç IP APR√àS (VPN) :"
          curl --max-time 5 https://ifconfig.me

      - name: Install Python Deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Bot
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python main.py


